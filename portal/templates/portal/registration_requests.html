{% extends "knowledgebase/base.html" %}
{% load static %}

{% block title %}Запросы на регистрацию{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 40px auto; padding: 20px;">
    <h2>Запросы на регистрацию</h2>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}" style="padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        {% if pending_count > 0 %}
            <div class="alert alert-info" style="padding: 15px; border-radius: 4px; background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; margin: 0;">
                <strong>Ожидают рассмотрения: {{ pending_count }}</strong>
            </div>
        {% endif %}
        
        <div style="display: flex; gap: 10px; align-items: center;">
            <label for="status_filter" style="margin: 0; font-weight: 500;">Фильтр по статусу:</label>
            <select id="status_filter" onchange="window.location.href='?status=' + this.value" 
                    style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">Все</option>
                <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Ожидают одобрения</option>
                <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Одобрены</option>
                <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Отклонены</option>
            </select>
        </div>
    </div>

    <table class="table" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
        <thead>
            <tr style="background-color: #f8f9fa;">
                <th style="padding: 12px; border: 1px solid #dee2e6;">Имя пользователя</th>
                <th style="padding: 12px; border: 1px solid #dee2e6;">Email</th>
                <th style="padding: 12px; border: 1px solid #dee2e6;">Роль</th>
                <th style="padding: 12px; border: 1px solid #dee2e6;">Отдел</th>
                <th style="padding: 12px; border: 1px solid #dee2e6;">Статус</th>
                <th style="padding: 12px; border: 1px solid #dee2e6;">Дата создания</th>
                <th style="padding: 12px; border: 1px solid #dee2e6;">Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for req in requests %}
            <tr>
                <td style="padding: 12px; border: 1px solid #dee2e6;">{{ req.username }}</td>
                <td style="padding: 12px; border: 1px solid #dee2e6;">{{ req.email }}</td>
                <td style="padding: 12px; border: 1px solid #dee2e6;">{{ req.get_requested_role_display }}</td>
                <td style="padding: 12px; border: 1px solid #dee2e6;">{{ req.department.name|default:"—" }}</td>
                <td style="padding: 12px; border: 1px solid #dee2e6;">
                    <span class="badge badge-{{ req.status }}" style="padding: 5px 10px; border-radius: 4px; 
                        {% if req.status == 'pending' %}background-color: #ffc107; color: #212529;
                        {% elif req.status == 'approved' %}background-color: #28a745; color: white;
                        {% else %}background-color: #dc3545; color: white;{% endif %}">
                        {{ req.get_status_display }}
                    </span>
                </td>
                <td style="padding: 12px; border: 1px solid #dee2e6;">{{ req.created_at|date:"d.m.Y H:i" }}</td>
                <td style="padding: 12px; border: 1px solid #dee2e6;">
                    {% if req.status == 'pending' %}
                        <a href="{% url 'portal:approve_registration' req.id %}" class="btn btn-sm btn-success" 
                           style="padding: 5px 10px; margin-right: 5px; background-color: #28a745; color: white; text-decoration: none; border-radius: 4px;">
                            Одобрить
                        </a>
                        <a href="{% url 'portal:reject_registration' req.id %}" class="btn btn-sm btn-danger"
                           style="padding: 5px 10px; background-color: #dc3545; color: white; text-decoration: none; border-radius: 4px;">
                            Отклонить
                        </a>
                    {% else %}
                        <div style="color: #6c757d; font-size: 12px;">
                            {% if req.reviewed_by %}
                                <strong>Рассмотрел:</strong> {{ req.reviewed_by.username }}<br>
                                <strong>Дата:</strong> {{ req.reviewed_at|date:"d.m.Y H:i" }}<br>
                                {% if req.status == 'rejected' and req.rejection_reason %}
                                    <strong>Причина отклонения:</strong><br>
                                    <span style="color: #dc3545; font-style: italic;">{{ req.rejection_reason }}</span>
                                {% endif %}
                            {% endif %}
                        </div>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" style="padding: 20px; text-align: center; color: #6c757d;">
                    Нет запросов на регистрацию
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div style="margin-top: 20px;">
        <a href="{% url 'portal:home' %}" class="btn btn-secondary">Вернуться на главную</a>
    </div>
</div>

<style>
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }
    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }
    .btn-secondary:hover {
        background-color: #5a6268;
    }
</style>
{% endblock %}



