{% extends 'knowledgebase/base.html' %}
{% load static %}

{% block title %}–ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π{% endblock %}

{% block content %}
<div class="requests-container">
  
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
  <div class="requests-header">
    <h1>üé´ –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π</h1>
    
    <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
    <div class="requests-instructions-box">
      <h3>üìñ –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è</h3>
      <div class="requests-instructions-grid">
        <div>
          <strong>üé´ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞–º–∏:</strong>
          <ul>
            {% if user.is_authenticated %}
              <li>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞</li>
              <li>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</li>
              <li>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø—Ä–∞–≤)</li>
              <li>–£–¥–∞–ª–µ–Ω–∏–µ (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø—Ä–∞–≤)</li>
            {% else %}
              <li>–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º</li>
              <li>–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É</li>
            {% endif %}
          </ul>
        </div>
        <div>
          <strong>‚öôÔ∏è –û–±—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:</strong>
          <ul>
            <li>üîç –ü–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º</li>
            <li>üîΩ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É</li>
            <li>üß≠ –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è -->
  <div class="search-filter-section">
    <form method="get" action="{% url 'knowledgebase:requests-page' %}" class="search-filter-form">
      <div class="form-group">
        <label>üîç –ü–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º</label>
        <input type="text" 
               name="query"
               placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é..."
               value="{{ query }}"
               class="form-control">
      </div>
      <div class="form-group">
        <label>üîΩ –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É</label>
        <select name="status" class="form-control">
          <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
          <option value="New" {% if status_filter == 'New' %}selected{% endif %}>–ù–æ–≤–∞—è</option>
          <option value="In Progress" {% if status_filter == 'In Progress' %}selected{% endif %}>–í —Ä–∞–±–æ—Ç–µ</option>
          <option value="Completed" {% if status_filter == 'Completed' %}selected{% endif %}>–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
          <option value="Cancelled" {% if status_filter == 'Cancelled' %}selected{% endif %}>–û—Ç–º–µ–Ω–µ–Ω–∞</option>
        </select>
      </div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary">üîç –ù–∞–π—Ç–∏</button>
        {% if query or status_filter %}
          <a href="{% url 'knowledgebase:requests-page' %}" class="btn btn-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
        {% endif %}
      </div>
    </form>
  </div>

  <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ -->
  {% if user.is_authenticated %}
    <div class="create-request-form">
      <h2>‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</h2>
      <form method="post">
        {% csrf_token %}
        <div class="form-grid">
          <div class="form-group">
            <label for="{{ form.title.id_for_label }}">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ *</label>
            {{ form.title }}
          </div>
          <div class="form-group">
            <label for="{{ form.description.id_for_label }}">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
            {{ form.description }}
          </div>
          <div class="form-group">
            <label for="{{ form.category.id_for_label }}">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            {{ form.category }}
          </div>
          <div class="form-group">
            <button type="submit" class="btn btn-primary">üì§ –°–æ–∑–¥–∞—Ç—å –∑–∞–ø—Ä–æ—Å</button>
          </div>
        </div>
      </form>
    </div>
  {% else %}
    <div class="alert alert-warning">
      <p>–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.</p>
      <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-primary">üîê –í–æ–π—Ç–∏</a>
    </div>
  {% endif %}

  <!-- –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ -->
  <div class="requests-list">
    <h2>üìã –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ {% if query or status_filter %}(–Ω–∞–π–¥–µ–Ω–æ: {{ requests|length }}){% else %}({{ requests|length }}){% endif %}</h2>
    
    {% if requests %}
      <div class="table-responsive">
        <table class="requests-table">
          <thead>
            <tr>
              <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
              <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
              <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody>
            {% for req in requests %}
              <tr>
                <td>
                  <a href="{% url 'knowledgebase:request_detail' req.id %}" class="request-link">
                    {{ req.title }}
                  </a>
                </td>
                <td class="request-description">
                  {{ req.description|truncatewords:15 }}
                </td>
                <td>
                  <span class="category-badge">
                    {{ req.get_category_display }}
                  </span>
                </td>
                <td>
                  <span class="status-badge status-{{ req.status|lower|slugify }}">
                    {{ req.get_status_display }}
                  </span>
                </td>
                <td>
                  <div class="action-buttons">
                    {% if perms.knowledgebase.change_request %}
                      <div class="status-buttons">
                        <form method="post" action="{% url 'knowledgebase:change-request-status' req.id %}" style="display:inline;">
                          {% csrf_token %}
                          <input type="hidden" name="status" value="New">
                          <button type="submit" 
                                  class="btn btn-sm status-btn-new"
                                  title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å: –ù–æ–≤–∞—è">
                            üÜï
                          </button>
                        </form>
                        <form method="post" action="{% url 'knowledgebase:change-request-status' req.id %}" style="display:inline;">
                          {% csrf_token %}
                          <input type="hidden" name="status" value="In Progress">
                          <button type="submit" 
                                  class="btn btn-sm status-btn-progress"
                                  title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å: –í —Ä–∞–±–æ—Ç–µ">
                            üîÑ
                          </button>
                        </form>
                        <form method="post" action="{% url 'knowledgebase:change-request-status' req.id %}" style="display:inline;">
                          {% csrf_token %}
                          <input type="hidden" name="status" value="Completed">
                          <button type="submit" 
                                  class="btn btn-sm status-btn-completed"
                                  title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å: –ó–∞–≤–µ—Ä—à–µ–Ω–∞">
                            ‚úÖ
                          </button>
                        </form>
                        <form method="post" action="{% url 'knowledgebase:change-request-status' req.id %}" style="display:inline;">
                          {% csrf_token %}
                          <input type="hidden" name="status" value="Cancelled">
                          <button type="submit" 
                                  class="btn btn-sm status-btn-cancelled"
                                  title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å: –û—Ç–º–µ–Ω–µ–Ω–∞">
                            ‚ùå
                          </button>
                        </form>
                      </div>
                    {% endif %}
                    {% if perms.knowledgebase.delete_request %}
                      <form method="post" action="{% url 'knowledgebase:delete-request' req.id %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" 
                                onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø—Ä–æ—Å?')"
                                class="btn btn-danger btn-sm">
                          üóëÔ∏è
                        </button>
                      </form>
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="no-requests">–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç. {% if user.is_authenticated %}–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞—è–≤–∫—É!{% else %}–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–æ–∫.{% endif %} üé´</p>
    {% endif %}
  </div>
</div>
{% endblock %}
