{% extends 'knowledgebase/base.html' %}
{% load static %}

{% block title %}{{ article.title }} ‚Äî –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π{% endblock %}

{% block content %}
<div class="article-container">
  
  <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
  <nav class="breadcrumb">
    <a href="{% url 'knowledgebase:index' %}">‚Üê –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</a>
    <span>/</span>
    <span>{{ article.title|truncatewords:5 }}</span>
  </nav>

  <!-- –°—Ç–∞—Ç—å—è -->
  <article class="article-content">
    <h1>{{ article.title }}</h1>
    
    <div class="article-meta">
      <span>üìÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: {{ article.pub_date|date:"d M Y H:i" }}</span>
    </div>

    <div class="article-body">
      {{ article.content|linebreaks }}
    </div>

    <!-- –ú–µ–¥–∏–∞ —Ñ–∞–π–ª—ã -->
    {% if article.image %}
      <div class="article-media">
        <img src="{{ article.image.url }}" alt="{{ article.title }}">
      </div>
    {% endif %}

    {% if article.video %}
      <div class="article-media">
        <video controls width="100%">
          <source src="{{ article.video.url }}" type="video/mp4">
          –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ —Ç–µ–≥.
        </video>
      </div>
    {% endif %}

    {% if article.audio %}
      <div class="article-media">
        <audio controls>
          <source src="{{ article.audio.url }}" type="audio/mpeg">
          –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç.
        </audio>
      </div>
    {% endif %}

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div class="article-actions">
      {% if user.is_authenticated and perms.knowledgebase.change_article %}
        <a href="{% url 'knowledgebase:article_edit' article.id %}" class="btn btn-warning">
          ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        </a>
      {% endif %}
      {% if user.is_authenticated and perms.knowledgebase.delete_article %}
        <form method="post" action="{% url 'knowledgebase:article_delete' article.id %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" 
                  onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç—å—é?')"
                  class="btn btn-danger">
            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
          </button>
        </form>
      {% endif %}
      <a href="{% url 'knowledgebase:index' %}" class="btn btn-secondary">
        ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
      </a>
    </div>
  </article>

  <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
  <section class="comments-section">
    <h2>
      üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
      <span class="comments-count">{{ comments|length }}</span>
    </h2>

    {% if comments %}
      <div class="comments-list">
        {% for comment in comments %}
          <div class="comment-item">
            <div class="comment-header">
              <div>
                <strong class="comment-author">
                  {% if comment.user %}
                    üë§ {{ comment.user.username }}
                  {% else %}
                    üë§ –ê–Ω–æ–Ω–∏–º
                  {% endif %}
                </strong>
                <span class="comment-date">
                  {{ comment.created_at|date:"d M Y H:i" }}
                </span>
              </div>
              {% if user.is_authenticated %}
                {% if perms.knowledgebase.delete_comment or comment.user_id == user.id %}
                  <form method="post" action="{% url 'knowledgebase:comment_delete' comment.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" 
                            onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')"
                            class="comment-delete-btn">
                      üóëÔ∏è
                    </button>
                  </form>
                {% endif %}
              {% endif %}
            </div>
            <p class="comment-text">{{ comment.text|linebreaks }}</p>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="no-comments">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º! üí≠</p>
    {% endif %}

    <div class="add-comment">
      {% if user.is_authenticated %}
        <h3>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>
        <form method="post">
          {% csrf_token %}
          <div class="form-group">
            {{ form.text }}
          </div>
          <button type="submit" class="btn btn-primary">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
        </form>
      {% else %}
        <div class="login-prompt">
          <p>
            –ß—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π,
          </p>
          <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-primary">
            üîê –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É
          </a>
        </div>
      {% endif %}
    </div>
  </section>
</div>
{% endblock %}
